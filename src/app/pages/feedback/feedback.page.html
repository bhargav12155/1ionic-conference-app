<ion-header [translucent]="true">
    <ion-toolbar>
        <ion-title>
            <ion-icon name="analytics" class="title-icon"></ion-icon>
            Feedback Dashboard
        </ion-title>
        <ion-buttons slot="end">
            <ion-button fill="clear" (click)="refresh()">
                <ion-icon name="refresh-circle" slot="icon-only"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="refresh()">
                <ion-icon name="reload" slot="icon-only"></ion-icon>
            </ion-button>
        </ion-buttons>
    </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="feedback-content">
    <ion-header collapse="condense">
        <ion-toolbar>
            <ion-title size="large">
                <ion-icon name="analytics" class="title-icon"></ion-icon>
                Feedback Dashboard
            </ion-title>
        </ion-toolbar>
    </ion-header>

    <!-- Enhanced Summary Cards -->
    <div class="summary-section">
        <ion-card class="summary-card glass-card">
            <ion-card-content>
                <div class="summary-item">
                    <ion-icon name="documents"></ion-icon>
                    <div>
                        <h3>{{filtered.length}}</h3>
                        <p>Total Feedback</p>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="summary-card glass-card">
            <ion-card-content>
                <div class="summary-item">
                    <ion-icon name="thumbs-up"></ion-icon>
                    <div>
                        <h3>{{positiveCount}}</h3>
                        <p>Positive Referrals</p>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="summary-card glass-card">
            <ion-card-content>
                <div class="summary-item">
                    <ion-icon name="today"></ion-icon>
                    <div>
                        <h3>{{todayCount}}</h3>
                        <p>Today's Feedback</p>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>

        <ion-card class="summary-card glass-card">
            <ion-card-content>
                <div class="summary-item">
                    <ion-icon name="trending-up"></ion-icon>
                    <div>
                        <h3>{{positiveCount}}</h3>
                        <p>Total Referrals</p>
                    </div>
                </div>
            </ion-card-content>
        </ion-card>
    </div>

    <!-- Enhanced Filters Section -->
    <ion-card class="filters-card glass-card">
        <ion-card-header>
            <ion-card-title>
                <ion-icon name="options"></ion-icon>
                Advanced Filters
            </ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <div class="filters-grid">
                <div class="search-container">
                    <ion-searchbar [(ngModel)]="search" (ionInput)="onSearchChange($event)"
                        placeholder="🔍 Search feedback, names, emails..." show-clear-button="focus">
                    </ion-searchbar>
                </div>

                <div class="filter-group">
                    <ion-item lines="none">
                        <ion-label>Time Period</ion-label>
                        <ion-select interface="popover" [(ngModel)]="timeFilter" (ionChange)="currentPage=1"
                            [disabled]="startDateTime || endDateTime">
                            <ion-select-option value="all">All Time</ion-select-option>
                            <ion-select-option value="24h">Last 24h</ion-select-option>
                            <ion-select-option value="7d">Last 7 days</ion-select-option>
                            <ion-select-option value="30d">Last 30 days</ion-select-option>
                        </ion-select>
                    </ion-item>
                </div>

                <div class="date-range-group">
                    <div class="range-input-group">
                        <ion-item lines="none">
                            <ion-label position="stacked">From Date & Time</ion-label>
                            <input type="datetime-local" class="custom-datetime" [(ngModel)]="startDateTime"
                                (change)="onDateRangeChange()" />
                        </ion-item>
                    </div>
                    <div class="range-input-group">
                        <ion-item lines="none">
                            <ion-label position="stacked">To Date & Time</ion-label>
                            <input type="datetime-local" class="custom-datetime" [(ngModel)]="endDateTime"
                                (change)="onDateRangeChange()" />
                        </ion-item>
                    </div>
                    <ion-button fill="clear" color="medium" (click)="clearRange()"
                        [disabled]="!startDateTime && !endDateTime">
                        <ion-icon name="close-circle-outline"></ion-icon>
                        Clear
                    </ion-button>
                </div>

                <div class="filter-group">
                    <ion-item lines="none">
                        <ion-label>Referral Filter</ion-label>
                        <ion-select interface="popover" [(ngModel)]="referralFilter" (ionChange)="currentPage=1">
                            <ion-select-option value="all">All Referrals</ion-select-option>
                            <ion-select-option value="Yes">Yes</ion-select-option>
                            <ion-select-option value="No">No</ion-select-option>
                            <ion-select-option value="Maybe">Maybe</ion-select-option>
                        </ion-select>
                    </ion-item>
                </div>
            </div>

            <div class="action-buttons">
                <ion-button fill="outline" (click)="exportCSV()" [disabled]="!filtered.length">
                    <ion-icon name="download-outline" slot="start"></ion-icon>
                    Export CSV
                </ion-button>
                <ion-button fill="outline" (click)="exportPrint()" [disabled]="!filtered.length">
                    <ion-icon name="print-outline" slot="start"></ion-icon>
                    Print/PDF
                </ion-button>
            </div>

            <!-- Filter Info Display -->
            <div class="filter-info" *ngIf="hasCustomRange() || timeFilter !== 'all'">
                <ion-chip [color]="isDateRangeValid ? 'primary' : 'warning'">
                    <ion-icon [name]="isDateRangeValid ? 'funnel' : 'warning'"></ion-icon>
                    <ion-label>{{filterInfo}}</ion-label>
                </ion-chip>
            </div>
        </ion-card-content>
    </ion-card>

    <!-- Status Section -->
    <div class="status-section" *ngIf="status">
        <ion-chip [color]="getStatusColor()">
            <ion-icon [name]="getStatusIcon()"></ion-icon>
            <ion-label>{{status}}</ion-label>
        </ion-chip>
    </div>

    <!-- Enhanced Data Table -->
    <ion-card class="data-card glass-card">
        <ion-card-header>
            <ion-card-title>
                <ion-icon name="library"></ion-icon>
                Feedback Database
                <span class="record-count">{{filtered.length}} entries</span>
            </ion-card-title>
        </ion-card-header>
        <ion-card-content>
            <div class="table-container">
                <ion-spinner *ngIf="loading" name="circles"></ion-spinner>
                <div class="table-responsive" [class.loading]="loading">
                    <table id="feedbackTable" class="professional-table">
                        <thead>
                            <tr>
                                <th (click)="setSort('timestamp')" class="sortable">
                                    <div class="header-content">
                                        <ion-icon name="calendar"></ion-icon>
                                        Date
                                        <ion-icon *ngIf="sortColumn==='timestamp'"
                                            [name]="sortDirection==='asc'?'chevron-up':'chevron-down'"
                                            class="sort-indicator"></ion-icon>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="time"></ion-icon>
                                        Time
                                    </div>
                                </th>
                                <th (click)="setSort('contact.name')" class="sortable">
                                    <div class="header-content">
                                        <ion-icon name="person"></ion-icon>
                                        Name
                                        <ion-icon *ngIf="sortColumn==='contact.name'"
                                            [name]="sortDirection==='asc'?'chevron-up':'chevron-down'"
                                            class="sort-indicator"></ion-icon>
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="chatbubble-ellipses"></ion-icon>
                                        Feedback
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="at"></ion-icon>
                                        Email
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="heart"></ion-icon>
                                        Positives
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="sad"></ion-icon>
                                        Improvements
                                    </div>
                                </th>
                                <th>
                                    <div class="header-content">
                                        <ion-icon name="star"></ion-icon>
                                        Referral Status
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let r of paginated; trackBy: trackByFn" class="data-row">
                                <td class="date-cell">{{formatDate(r.timestamp)}}</td>
                                <td class="time-cell">{{formatTime(r.timestamp)}}</td>
                                <td class="name-cell">
                                    <div class="cell-content">
                                        <ion-avatar *ngIf="r.contact?.name" class="mini-avatar">
                                            <div class="avatar-text">{{getInitials(r.contact.name)}}</div>
                                        </ion-avatar>
                                        {{r.contact?.name || '—'}}
                                    </div>
                                </td>
                                <td class="feedback-cell">
                                    <div class="feedback-text" [title]="r.propertyFeedback?.overall">
                                        {{truncateText(r.propertyFeedback?.overall, 50)}}
                                    </div>
                                </td>
                                <td class="email-cell">{{r.contact?.email || '—'}}</td>
                                <td class="positives-cell">
                                    <div class="positives-text" [title]="r.propertyFeedback?.positives">
                                        {{truncateText(r.propertyFeedback?.positives, 30)}}
                                    </div>
                                </td>
                                <td class="negatives-cell">
                                    <div class="negatives-text" [title]="r.propertyFeedback?.negatives">
                                        {{truncateText(r.propertyFeedback?.negatives, 30)}}
                                    </div>
                                </td>
                                <td class="referral-cell">
                                    <ion-chip [color]="getReferralColor(r.propertyFeedback?.referralPotential)">
                                        <ion-icon
                                            [name]="getReferralIcon(r.propertyFeedback?.referralPotential)"></ion-icon>
                                        <ion-label>{{r.propertyFeedback?.referralPotential || '—'}}</ion-label>
                                    </ion-chip>
                                </td>
                            </tr>
                            <tr *ngIf="paginated.length===0 && !loading" class="empty-state">
                                <td colspan="8">
                                    <div class="empty-content">
                                        <ion-icon name="document-outline" size="large"></ion-icon>
                                        <h3>No feedback records found</h3>
                                        <p>Try adjusting your filters or refresh the data</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Professional Action Bar -->
            <div class="action-bar" *ngIf="filtered.length > 0">
                <div class="export-section">
                    <ion-button fill="solid" color="success" (click)="exportToCSV()" class="export-btn">
                        <ion-icon name="download" slot="start"></ion-icon>
                        Export CSV
                    </ion-button>
                    <ion-button fill="outline" color="primary" (click)="printTable()" class="print-btn">
                        <ion-icon name="print" slot="start"></ion-icon>
                        Print Report
                    </ion-button>
                </div>
                <div class="summary-text">
                    <ion-text color="medium">
                        <strong>{{filtered.length}}</strong> records match your criteria
                    </ion-text>
                </div>
            </div>

            <!-- Enhanced Pagination -->
            <div class="pagination-container" *ngIf="totalPages > 1">
                <div class="pagination-info">
                    Showing {{(currentPage-1)*pageSize + 1}} to {{Math.min(currentPage*pageSize, filtered.length)}} of
                    {{filtered.length}} records
                </div>
                <div class="pagination-controls">
                    <ion-button fill="clear" (click)="changePage(1)" [disabled]="currentPage === 1">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </ion-button>
                    <ion-button fill="clear" (click)="changePage(currentPage-1)" [disabled]="currentPage === 1">
                        <ion-icon name="chevron-back-outline"></ion-icon>
                    </ion-button>

                    <div class="page-numbers">
                        <ion-button *ngFor="let page of getPageNumbers()" fill="clear"
                            [color]="page === currentPage ? 'primary' : 'medium'" (click)="changePage(page)">
                            {{page}}
                        </ion-button>
                    </div>

                    <ion-button fill="clear" (click)="changePage(currentPage+1)"
                        [disabled]="currentPage === totalPages">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </ion-button>
                    <ion-button fill="clear" (click)="changePage(totalPages)" [disabled]="currentPage === totalPages">
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                        <ion-icon name="chevron-forward-outline"></ion-icon>
                    </ion-button>
                </div>
            </div>
        </ion-card-content>
    </ion-card>
</ion-content>